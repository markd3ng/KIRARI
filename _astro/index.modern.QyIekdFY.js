import{Location as w,getCurrentUrl as L}from"./Swup.modern.DR8tGCtn.js";function b(){return b=Object.assign?Object.assign.bind():function(c){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(c[r]=t[r])}return c},b.apply(this,arguments)}const E=c=>String(c).split(".").map(e=>String(parseInt(e||"0",10))).concat(["0","0"]).slice(0,3).join(".");class S{constructor(){this.isSwupPlugin=!0,this.swup=void 0,this.version=void 0,this.requires={},this.handlersToUnregister=[]}mount(){}unmount(){this.handlersToUnregister.forEach(e=>e()),this.handlersToUnregister=[]}_beforeMount(){if(!this.name)throw new Error("You must define a name of plugin when creating a class.")}_afterUnmount(){}_checkRequirements(){return typeof this.requires!="object"||Object.entries(this.requires).forEach(([e,t])=>{if(!(function(r,o,s){const i=(function(a,n){var l;if(a==="swup")return(l=n.version)!=null?l:"";{var p;const f=n.findPlugin(a);return(p=f?.version)!=null?p:""}})(r,s);return!!i&&((a,n)=>n.every(l=>{const[,p,f]=l.match(/^([\D]+)?(.*)$/)||[];var v,g;return((h,u)=>{const m={"":d=>d===0,">":d=>d>0,">=":d=>d>=0,"<":d=>d<0,"<=":d=>d<=0};return(m[u]||m[""])(h)})((g=f,v=E(v=a),g=E(g),v.localeCompare(g,void 0,{numeric:!0})),p||">=")}))(i,o)})(e,t=Array.isArray(t)?t:[t],this.swup)){const r=`${e} ${t.join(", ")}`;throw new Error(`Plugin version mismatch: ${this.name} requires ${r}`)}}),!0}on(e,t,r={}){var o;t=!(o=t).name.startsWith("bound ")||o.hasOwnProperty("prototype")?t.bind(this):t;const s=this.swup.hooks.on(e,t,r);return this.handlersToUnregister.push(s),s}once(e,t,r={}){return this.on(e,t,b({},r,{once:!0}))}before(e,t,r={}){return this.on(e,t,b({},r,{before:!0}))}replace(e,t,r={}){return this.on(e,t,b({},r,{replace:!0}))}off(e,t){return this.swup.hooks.off(e,t)}}function k(){return k=Object.assign?Object.assign.bind():function(c){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)({}).hasOwnProperty.call(t,r)&&(c[r]=t[r])}return c},k.apply(null,arguments)}function O(){return window.matchMedia("(hover: hover)").matches}function y(c){return!!c&&(c instanceof HTMLAnchorElement||c instanceof SVGAElement)}const V=window.requestIdleCallback||(c=>setTimeout(c,1)),q=["preloadVisibleLinks"];class A extends S{constructor(e={}){var t;super(),t=this,this.name="SwupPreloadPlugin",this.requires={swup:">=4.5"},this.defaults={throttle:5,preloadInitialPage:!0,preloadHoveredLinks:!0,preloadVisibleLinks:{enabled:!1,threshold:.2,delay:500,containers:["body"],ignore:()=>!1}},this.options=void 0,this.queue=void 0,this.preloadObserver=void 0,this.preloadPromises=new Map,this.mouseEnterDelegate=void 0,this.touchStartDelegate=void 0,this.focusDelegate=void 0,this.onPageLoad=(s,i,a)=>{const{url:n}=s.to;return n&&this.preloadPromises.has(n)?this.preloadPromises.get(n):a(s,i)},this.onMouseEnter=async function(s){if(s.target!==s.delegateTarget||!O())return;const i=s.delegateTarget;if(!y(i))return;const{url:a,hash:n}=w.fromElement(i),l=t.swup.createVisit({to:a,hash:n,el:i,event:s});t.swup.hooks.callSync("link:hover",l,{el:i,event:s}),t.preload(i,{priority:!0})},this.onTouchStart=s=>{if(O())return;const i=s.delegateTarget;y(i)&&this.preload(i,{priority:!0})},this.onFocus=s=>{const i=s.delegateTarget;y(i)&&this.preload(i,{priority:!0})};const{preloadVisibleLinks:r}=e,o=(function(s,i){if(s==null)return{};var a={};for(var n in s)if({}.hasOwnProperty.call(s,n)){if(i.includes(n))continue;a[n]=s[n]}return a})(e,q);this.options=k({},this.defaults,o),typeof r=="object"?this.options.preloadVisibleLinks=k({},this.options.preloadVisibleLinks,{enabled:!0},r):this.options.preloadVisibleLinks.enabled=!!r,this.preload=this.preload.bind(this),this.queue=(function(s=1){const i=[],a=[];let n=0,l=0;function p(){l<s&&n>0&&((a.shift()||i.shift()||(()=>{}))(),n--,l++)}return{add:function(f,v=!1){if(f.__queued){if(!v)return;{const g=i.indexOf(f);if(g>=0){const h=i.splice(g,1);n-=h.length}}}f.__queued=!0,(v?a:i).push(f),n++,n<=1&&p()},next:function(){l--,p()}}})(this.options.throttle)}mount(){const e=this.swup;e.options.cache?(e.hooks.create("page:preload"),e.hooks.create("link:hover"),e.preload=this.preload,e.preloadLinks=this.preloadLinks,this.replace("page:load",this.onPageLoad),this.preloadLinks(),this.on("page:view",()=>this.preloadLinks()),this.options.preloadVisibleLinks.enabled&&(this.preloadVisibleLinks(),this.on("page:view",()=>this.preloadVisibleLinks())),this.options.preloadHoveredLinks&&this.preloadLinksOnAttention(),this.options.preloadInitialPage&&this.preload(L())):console.warn("SwupPreloadPlugin: swup cache needs to be enabled for preloading")}unmount(){var e,t,r;this.swup.preload=void 0,this.swup.preloadLinks=void 0,this.preloadPromises.clear(),(e=this.mouseEnterDelegate)==null||e.destroy(),(t=this.touchStartDelegate)==null||t.destroy(),(r=this.focusDelegate)==null||r.destroy(),this.stopPreloadingVisibleLinks()}async preload(e,t={}){var r;let o,s;const i=(r=t.priority)!=null&&r;if(Array.isArray(e))return Promise.all(e.map(n=>this.preload(n)));if(y(e))s=e,{href:o}=w.fromElement(e);else{if(typeof e!="string")return;o=e}if(!o)return;if(this.swup.cache.has(o))return this.swup.cache.get(o);if(this.preloadPromises.has(o))return this.preloadPromises.get(o);if(!this.shouldPreload(o,{el:s}))return;const a=new Promise(n=>{this.queue.add(()=>{this.performPreload(o).catch(()=>{}).then(l=>n(l)).finally(()=>{this.queue.next(),this.preloadPromises.delete(o)})},i)});return this.preloadPromises.set(o,a),a}preloadLinks(){V(()=>{Array.from(document.querySelectorAll("a[data-swup-preload], [data-swup-preload-all] a")).forEach(e=>this.preload(e))})}preloadLinksOnAttention(){const{swup:e}=this,{linkSelector:t}=e.options,r={passive:!0,capture:!0};this.mouseEnterDelegate=e.delegateEvent(t,"mouseenter",this.onMouseEnter,r),this.touchStartDelegate=e.delegateEvent(t,"touchstart",this.onTouchStart,r),this.focusDelegate=e.delegateEvent(t,"focus",this.onFocus,r)}preloadVisibleLinks(){if(this.preloadObserver)return void this.preloadObserver.update();const{threshold:e,delay:t,containers:r}=this.options.preloadVisibleLinks;this.preloadObserver=(function({threshold:o,delay:s,containers:i,callback:a,filter:n}){const l=new Map,p=new IntersectionObserver(h=>{h.forEach(u=>{u.isIntersecting?f(u.target):v(u.target)})},{threshold:o}),f=h=>{var u;const{href:m}=w.fromElement(h),d=(u=l.get(m))!=null?u:new Set;l.set(m,d),d.add(h),setTimeout(()=>{const P=l.get(m);P!=null&&P.size&&(a(h),p.unobserve(h),P.delete(h))},s)},v=h=>{var u;const{href:m}=w.fromElement(h);(u=l.get(m))==null||u.delete(h)},g=()=>{V(()=>{const h=i.map(u=>`${u} a[*|href]`).join(", ");Array.from(document.querySelectorAll(h)).filter(u=>n(u)).forEach(u=>p.observe(u))})};return{start:()=>g(),stop:()=>p.disconnect(),update:()=>(l.clear(),g())}})({threshold:e,delay:t,containers:r,callback:o=>this.preload(o),filter:o=>{if(this.options.preloadVisibleLinks.ignore(o)||!o.matches(this.swup.options.linkSelector))return!1;const{href:s}=w.fromElement(o);return this.shouldPreload(s,{el:o})}}),this.preloadObserver.start()}stopPreloadingVisibleLinks(){this.preloadObserver&&this.preloadObserver.stop()}shouldPreload(e,{el:t}={}){const{url:r,href:o}=w.fromUrl(e);return!(!(function(){if(navigator.connection){var s;if(navigator.connection.saveData||(s=navigator.connection.effectiveType)!=null&&s.endsWith("2g"))return!1}return!0})()||this.swup.cache.has(r)||this.preloadPromises.has(r)||this.swup.shouldIgnoreVisit(o,{el:t})||t&&this.swup.resolveUrl(r)===this.swup.resolveUrl(L()))}async performPreload(e){var t=this;const{url:r}=w.fromUrl(e),o=this.swup.createVisit({to:r});return await this.swup.hooks.call("page:preload",o,{url:r},async function(i,a){return a.page=await t.swup.fetchPage(e,{visit:i}),a.page})}}export{A as default};
